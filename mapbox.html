<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boat Tracker Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      position: relative;
    }
    /* Sidebar styles */
#sidebar {
  position: absolute;
  top: 0;
  left: 0;
  width: 250px;      /* fixed width */
  height: 100%;      /* full height */
  background: #f8f8f8;
  border-right: 1px solid #ccc;
  padding: 10px 15px;
  box-sizing: border-box;
  overflow-y: auto;  /* scroll if content is long */
  font-family: Arial, sans-serif;
  z-index: 1100;     /* above map controls */
}

#sidebar h3 {
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 1.2em;
  border-bottom: 1px solid #ccc;
  padding-bottom: 5px;
}

#pinList {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

#pinToggleBtn {
  position: absolute;
  top: 20px;
  left: 270px; /* right of sidebar */
  z-index: 1000;
  padding: 10px 16px;
  background: #ffdd57;
  color: black;
  font-weight: bold;
  border: 2px solid #333;
  border-radius: 5px;
  cursor: pointer;
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
}
#pinToggleBtn.active {
  background-color: #ff6347;
  color: white;
} 

/* Adjust map to not go under sidebar */
#map {
  position: absolute;
  top: 0;
  left: 250px;  /* leave space for sidebar */
  width: calc(100% - 250px);
  height: 100%;
}
    .car-marker {
      width: 40px;
      height: 40px;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/d/db/Blue_Arrow_Up_Darker.png');
      background-size: contain;
      background-repeat: no-repeat;
      transform-origin: center center;
    }

    .survivor-marker {
      width: 20px;
      height: 20px;
      background-color: red;
      border-radius: 50%;
      border: 2px solid white;
    }


    #centerBtn {
      position: absolute;
      bottom: 20px;     /* position from bottom */
      right: 20px;      /* position from right */
      z-index: 1000;
      padding: 10px 16px;
      background: white;
      color: black;
      font-weight: bold;
      border: 2px solid #000;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      display: none; /* Hidden at first */
    }
  </style>
</head>
<body>
  <!-- Sidebar for survivor pins list -->
  <div id="sidebar">
    <h3>Survivor Pins</h3>
    <ul id="pinList"></ul>
  </div>
<!-- Map -->
<div id="map"></div>

<!-- Center Robot Button -->
<button id="centerBtn">Center Robot</button>
<button id="pinToggleBtn">Pin Mode</button>
<button id="findRouteBtn" style="
  position: absolute;
  top: 70px; /* Just below the pin toggle button (which is at 20px + ~40px height) */
  left: 270px; /* Same as pinToggleBtn */
  z-index: 1000;
  padding: 10px 16px;
  background: #007bff; /* Your preferred blue */
  color: white;
  font-weight: bold;
  border: 2px solid #333;
  border-radius: 5px;
  cursor: pointer;
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
">
  Find Route
</button>



<script>
  // Mapbox access token
  mapboxgl.accessToken = 'pk.eyJ1Ijoic2t5ZTEyOSIsImEiOiJjbWJrdHZ3OXYwdTZxMmxwdjFqNjBqc2psIn0.ScnyAu71F8xdxE7Z9N49iA';

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDsOrjAd-h_d2N5gIKr7LD1yu_V9_K63r4",
    authDomain: "gpstest-3bed5.firebaseapp.com",
    databaseURL: "https://gpstest-3bed5-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "gpstest-3bed5",
    storageBucket: "gpstest-3bed5.appspot.com",
    messagingSenderId: "14670212530",
    appId: "1:14670212530:web:c4a346837779980d0fc8ab"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const initial = [101.6869, 3.1390];

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: initial,
    zoom: 16,
    pitch: 60,
    bearing: 0
  });

  map.addControl(new mapboxgl.NavigationControl());

  const carEl = document.createElement('div');
  carEl.className = 'car-marker';

  window.boatMarker = new mapboxgl.Marker(carEl)
    .setLngLat(initial)
    .addTo(map);

  let lastBoatLngLat = initial;

  function updateCar(lng, lat, heading) {
    lastBoatLngLat = [lng, lat];
    boatMarker.setLngLat([lng, lat]);
    carEl.style.transform = `rotate(${heading}deg)`;
  }

  // Firebase listener: boat position
  db.ref("boat").on("value", (snapshot) => {
    const data = snapshot.val();
    if (data) {
      updateCar(data.lng, data.lat, data.heading);
    }
  });

  const pinListEl = document.getElementById('pinList');

// Helper: render the sidebar list of pins
function renderPinList() {
  pinListEl.innerHTML = ''; // clear existing list

  // If no pins
  if (Object.keys(pinsMarkers).length === 0) {
    const emptyLi = document.createElement('li');
    emptyLi.textContent = 'No survivor pins';
    emptyLi.style.color = '#888';
    pinListEl.appendChild(emptyLi);
    return;
  }

  for (const key in pinsMarkers) {
    const marker = pinsMarkers[key];
    const lngLat = marker.getLngLat();

    // Create list item container
    const li = document.createElement('li');
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.gap = '8px';
    li.style.padding = '4px 8px';
    li.style.borderBottom = '1px solid #ccc';
    li.style.cursor = 'pointer';

    // Create checkbox
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'pin-checkbox';
    checkbox.dataset.key = key;

    // Create label
    const label = document.createElement('span');
    label.textContent = `${marker._element.dataset.name || 'Unnamed'} (${lngLat.lat.toFixed(5)}, ${lngLat.lng.toFixed(5)})`;

    // Click on label or list item flies to pin (but not when clicking checkbox)
    li.addEventListener('click', (e) => {
      if (e.target.tagName !== 'INPUT') {
        map.easeTo({
          center: [lngLat.lng, lngLat.lat],
          zoom: 18,
          duration: 1000,
          pitch: 60
        });
      }
    });

    // Build the list item
    li.appendChild(checkbox);
    li.appendChild(label);
    pinListEl.appendChild(li);
  }
}


  // Firebase listener: survivor pins
  const pinsMarkers = {};
db.ref("pins").on("child_added", (snapshot) => {
  const key = snapshot.key;
  const pin = snapshot.val();

  if (!pinsMarkers[key]) {
    const el = document.createElement('div');
  el.className = 'survivor-marker';
  el.dataset.name = pin.name || `Survivor`; // ✅ Store the name in the marker

    const deleteBtn = document.createElement('div');
    deleteBtn.innerText = '×';
    deleteBtn.style.position = 'absolute';
    deleteBtn.style.top = '-10px';
    deleteBtn.style.right = '-10px';
    deleteBtn.style.width = '20px';
    deleteBtn.style.height = '20px';
    deleteBtn.style.backgroundColor = 'white';
    deleteBtn.style.color = 'red';
    deleteBtn.style.fontWeight = 'bold';
    deleteBtn.style.textAlign = 'center';
    deleteBtn.style.borderRadius = '50%';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.boxShadow = '0 0 4px rgba(0,0,0,0.5)';
    deleteBtn.title = 'Delete pin';

    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const confirmDelete = confirm("Delete this survivor pin?");
      if (confirmDelete) {
        db.ref("pins").child(key).remove();
      }
    });

    el.appendChild(deleteBtn);

    const pinMarker = new mapboxgl.Marker(el)
      .setLngLat([pin.lng, pin.lat])
      .addTo(map);

    pinsMarkers[key] = pinMarker;

    renderPinList();  // Update sidebar list after adding pin
  }
});

// Listen for survivor pin updates
db.ref("pins").on("child_changed", (snapshot) => {
  const key = snapshot.key;
  const pin = snapshot.val();

  if (pinsMarkers[key]) {
    pinsMarkers[key].setLngLat([pin.lng, pin.lat]);
    renderPinList();  // Update sidebar list in case location changed
  }
});

// Listen for survivor pin removals
db.ref("pins").on("child_removed", (snapshot) => {
  const key = snapshot.key;

  if (pinsMarkers[key]) {
    pinsMarkers[key].remove();
    delete pinsMarkers[key];
    renderPinList();  // Update sidebar list after removing pin
  }
});

  // Button logic
  const centerBtn = document.getElementById('centerBtn');

  map.on('dragstart', () => {
    centerBtn.style.display = 'block';
  });

  map.on('zoomstart', () => {
    centerBtn.style.display = 'block';
  });

  centerBtn.addEventListener('click', () => {
    map.easeTo({
      center: lastBoatLngLat,
      pitch: 60,
      duration: 1000
    });
    centerBtn.style.display = 'none';
  });

  let pinMode = false;

const pinToggleBtn = document.getElementById('pinToggleBtn');
pinToggleBtn.addEventListener('click', () => {
  pinMode = !pinMode;
  pinToggleBtn.classList.toggle('active', pinMode);
  pinToggleBtn.textContent = pinMode ? "Exit Pin Mode" : "Pin Mode";
});

map.on('click', (e) => {
  if (!pinMode) return;

  const lng = e.lngLat.lng;
  const lat = e.lngLat.lat;

  const confirmPin = confirm("Add a survivor pin here?");
  if (!confirmPin) return;

   // Save to Firebase with custom Survivor # name
  db.ref("pins").once("value", (snapshot) => {
    const count = snapshot.numChildren();
    const newPinRef = db.ref("pins").push();
    newPinRef.set({
      lat: lat,
      lng: lng,
      name: `Survivor #${count + 1}`
    });
  });

  // Exit pinning mode automatically after placing
  pinMode = false;
  pinToggleBtn.classList.remove('active');
  pinToggleBtn.textContent = "Pin Mode";
});



// Add this script to your existing HTML to compute and display a TSP route

// Button to trigger route finding
document.getElementById("findRouteBtn").addEventListener("click", () => {
  computeAndDrawRoute();
});

// Function to compute and draw the best route using Nearest Neighbor TSP
function computeAndDrawRoute() {
  if (!window.boatMarker) {
    alert("Boat location missing!");
    return;
  }

  const boatPos = boatMarker.getLngLat();
  const start = { lat: boatPos.lat, lng: boatPos.lng };

  // Get only selected (checked) survivor pins
  const selectedPins = Array.from(document.querySelectorAll('.pin-checkbox:checked'))
    .map(checkbox => {
      const key = checkbox.dataset.key;
      if (!pinsMarkers[key]) return null; // safety check
      const pos = pinsMarkers[key].getLngLat();
      return { key, lat: pos.lat, lng: pos.lng };
    })
    .filter(pin => pin !== null); // remove any nulls

  if (selectedPins.length === 0) {
    alert("No survivor pins selected!");
    return;
  }

  // Nearest Neighbor TSP logic
  const visited = new Set();
  const route = [start];
  let current = start;

  while (visited.size < selectedPins.length) {
    let nearest = null;
    let minDist = Infinity;

    for (const pin of selectedPins) {
      if (!visited.has(pin.key)) {
        const dist = haversine(current, pin);
        if (dist < minDist) {
          minDist = dist;
          nearest = pin;
        }
      }
    }

    if (nearest) {
      visited.add(nearest.key);
      route.push({ lat: nearest.lat, lng: nearest.lng });
      current = nearest;
    }
  }

  route.push(start); // Return to base
  drawRouteLine(route);
}

// Helper: Haversine distance (in meters)
function haversine(a, b) {
  const toRad = (d) => d * Math.PI / 180; // degrees → radians
  const R = 6371000; // Earth's radius in meters

  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);

  const a1 = Math.sin(dLat / 2) ** 2 +
             Math.cos(lat1) * Math.cos(lat2) *
             Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a1), Math.sqrt(1 - a1));

  return R * c; // distance in meters
}

// Draw route on the map
let routeLine;
function drawRouteLine(coords) {
  if (!coords || coords.length < 2) {
    console.warn("Not enough points to draw a route.");
    return;
  }

  console.log("Drawing route:", coords);  // ← Add this

  if (map.getLayer("routeLine")) map.removeLayer("routeLine");
  if (map.getSource("route")) map.removeSource("route");

  const routeGeoJSON = {
    type: "Feature",
    geometry: {
      type: "LineString",
      coordinates: coords.map(c => [c.lng, c.lat])
    }
  };

  map.addSource("route", { type: "geojson", data: routeGeoJSON });

  map.addLayer({
    id: "routeLine",
    type: "line",
    source: "route",
    layout: {},
    paint: {
      "line-color": "#ff7e5f",
      "line-width": 4
    }
  });

  map.flyTo({ center: coords[0] || [0,0], zoom: 16 });
}





  
</script>

</body>
</html>